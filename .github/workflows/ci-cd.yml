name: CI/CD Pipeline - Pomodoro App JS

on:
  push:
    branches: [ "main" ]

jobs:
  build-deploy:
    runs-on: ubuntu-latest

    env:
      SONAR_URL: 'http://3.93.191.37:9000'
      NEXUS_URL: 'http://54.90.212.15:8081'
      NEXUS_REPO: 'raw-releases'
      NEXUS_GROUP: 'com/web/pomodoro'
      NEXUS_ARTIFACT: 'pomodoro-app'
      NGINX_SERVER: '34.224.38.174'
      NGINX_WEB_ROOT: '/var/www/html'
      BUILD_VER: 0.0.${{ github.run_number }}
      TARBALL: pomodoro-app-${{ github.run_number }}.tar.gz

    steps:
      # --- Checkout Code ---
      - name: üì¶ Checkout Code
        uses: actions/checkout@v4

      # --- Setup Node.js ---
      - name: üü¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      # --- Install Dependencies ---
      - name: üì• Install Dependencies
        run: |
          npm install
          echo "‚úÖ Dependencies installed!"

      # --- SonarQube Analysis (Self-hosted) ---
      - name: üîç SonarQube Analysis
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        shell: bash
        run: |
          npm install --save-dev sonarqube-scanner
          echo "Running SonarQube scanner..."
          npx sonar-scanner $(cat <<EOF
            -Dsonar.projectKey=pomodoro-app-js
            -Dsonar.projectName=PomodoroAppJS
            -Dsonar.projectVersion=${{ env.BUILD_VER }}
            -Dsonar.sources=src
            -Dsonar.host.url=${{ env.SONAR_URL }}
            -Dsonar.token=${{ secrets.SONAR_TOKEN }}
            -Dsonar.sourceEncoding=UTF-8
          EOF
          )
          echo "‚úÖ SonarQube Analysis completed successfully!"

      # --- Run Tests ---
      - name: üß™ Run Tests
        run: |
          npm test || echo "‚ö†Ô∏è No tests found, skipping..."

      # --- Build Artifact ---
      - name: ‚öôÔ∏è Build Artifact
        run: |
          npm run build
          echo "‚úÖ Build Completed!"
          ls -lh dist/ || true

      # --- Package Artifact ---
      - name: üì¶ Package Artifact
        run: |
          tar -czf ${{ env.TARBALL }} -C dist .
          echo "‚úÖ Package created: ${{ env.TARBALL }}"
          ls -lh ${{ env.TARBALL }}

      # --- Upload to Nexus ---
      - name: üì§ Upload Artifact to Nexus
        env:
          NEXUS_USER: ${{ secrets.NEXUS_USER }}
          NEXUS_PASS: ${{ secrets.NEXUS_PASS }}
        run: |
          echo "üì§ Uploading artifact to Nexus..."
          curl -v -u $NEXUS_USER:$NEXUS_PASS --upload-file "${{ env.TARBALL }}" \
            "${{ env.NEXUS_URL }}/repository/${{ env.NEXUS_REPO }}/${{ env.NEXUS_GROUP }}/${{ env.NEXUS_ARTIFACT }}/${{ env.BUILD_VER }}/${{ env.TARBALL }}"
          echo "‚úÖ Artifact uploaded successfully to Nexus!"

      # --- Deploy to Nginx ---
      - name: üöÄ Deploy to Nginx
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ env.NGINX_SERVER }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_KEY }}
          script: |
            set -e
            cd /tmp
            rm -f *.tar.gz
            DOWNLOAD_URL="${{ env.NEXUS_URL }}/repository/${{ env.NEXUS_REPO }}/${{ env.NEXUS_GROUP }}/${{ env.NEXUS_ARTIFACT }}/${{ env.BUILD_VER }}/${{ env.TARBALL }}"
            echo "‚¨áÔ∏è Downloading tarball from: $DOWNLOAD_URL"
            curl -f -u ${{ secrets.NEXUS_USER }}:${{ secrets.NEXUS_PASS }} -O "$DOWNLOAD_URL"

            if [[ ! -f "${{ env.TARBALL }}" ]]; then
              echo "‚ùå Download failed!"
              exit 1
            fi

            echo "üöÄ Deploying to Nginx..."
            sudo mkdir -p ${{ env.NGINX_WEB_ROOT }}
            sudo rm -rf ${{ env.NGINX_WEB_ROOT }}/*
            sudo tar -xzf "${{ env.TARBALL }}" -C ${{ env.NGINX_WEB_ROOT }}/
            sudo chown -R www-data:www-data ${{ env.NGINX_WEB_ROOT }}
            echo "‚úÖ Deployment successful! Application live on Nginx!"
